<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Docker_store (obuilder.Obuilder.Docker_store)</title><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">obuilder</a> &#x00BB; <a href="../index.html">Obuilder</a> &#x00BB; Docker_store</nav><header class="odoc-preamble"><h1>Module <code><span>Obuilder.Docker_store</span></code></h1><p>Store build results as Docker images.</p></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../S/module-type-STORE/index.html">S.STORE</a></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-root"><a href="#val-root" class="anchor"></a><code><span><span class="keyword">val</span> root : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>root t</code> returns the root of the store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-df"><a href="#val-df" class="anchor"></a><code><span><span class="keyword">val</span> df : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>float <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>df t</code> returns the percentage of free space in the store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-build"><a href="#val-build" class="anchor"></a><code><span><span class="keyword">val</span> build : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?base:<a href="../S/index.html#type-id">S.id</a> <span class="arrow">&#45;&gt;</span></span>
  <span>id:<a href="../S/index.html#type-id">S.id</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'e</span>)</span> <span class="xref-unresolved">Lwt_result</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, <span class="type-var">'e</span>)</span> <span class="xref-unresolved">Lwt_result</span>.t</span></span></code></div><div class="spec-doc"><p><code>build t ~id fn</code> runs <code>fn tmpdir</code> to add a new item to the store under key <code>id</code>. On success, <code>tmpdir</code> is saved as <code>id</code>, which can be used as the <code>base</code> for further builds, until it is expired from the cache. On failure, nothing is recorded and calling <code>build</code> again will make another attempt at building it. The builder will not request concurrent builds for the same <code>id</code> (it will handle that itself). It will also not ask for a build that already exists (i.e. for which <code>result</code> returns a path).</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">base</span> <p>Initialise <code>tmpdir</code> as a clone of <code>base</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-delete"><a href="#val-delete" class="anchor"></a><code><span><span class="keyword">val</span> delete : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../S/index.html#type-id">S.id</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>delete t id</code> removes <code>id</code> from the store, if present.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-result"><a href="#val-result" class="anchor"></a><code><span><span class="keyword">val</span> result : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../S/index.html#type-id">S.id</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>result t id</code> is the path of the build result for <code>id</code>, if present.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log_file"><a href="#val-log_file" class="anchor"></a><code><span><span class="keyword">val</span> log_file : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../S/index.html#type-id">S.id</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>log_file t id</code> is the path of the build logs for <code>id</code>. The file may not exist if the build has never been run, or failed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-state_dir"><a href="#val-state_dir" class="anchor"></a><code><span><span class="keyword">val</span> state_dir : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>state_dir</code> is the path of a directory which can be used to store mutable state related to this store (e.g. an sqlite3 database).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cache"><a href="#val-cache" class="anchor"></a><code><span><span class="keyword">val</span> cache : 
  <span>user:<a href="../../../obuilder-spec/Obuilder_spec/index.html#type-user">Obuilder_spec.user</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(string * <span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>cache ~user t name</code> creates a writeable copy of the latest snapshot of the cache <code>name</code>. It returns the path of this fresh copy and a function which must be called to free it when done. If the cache <code>name</code> does not exist, it is first created (as an empty directory, and owned by <code>user</code>). When the copy is released, it is snapshotted to become the new latest version of the cache, unless the cache has already been updated since it was snapshotted, in which case this writeable copy is simply discarded.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-delete_cache"><a href="#val-delete_cache" class="anchor"></a><code><span><span class="keyword">val</span> delete_cache : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span>[&gt; `Busy ]</span>)</span> <span class="xref-unresolved">Lwt_result</span>.t</span></span></code></div><div class="spec-doc"><p><code>delete_cache t name</code> removes the cache <code>name</code>, if present. If the cache is currently in use, the store may instead return <code>Error `Busy</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-complete_deletes"><a href="#val-complete_deletes" class="anchor"></a><code><span><span class="keyword">val</span> complete_deletes : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>complete_deletes t</code> attempts to wait for previously executed deletes to finish, so that the free space is accurate.</p></div></div></details></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>create root</code> is a new store using Docker images and <code>root</code> to store ancillary state.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cache_stats"><a href="#val-cache_stats" class="anchor"></a><code><span><span class="keyword">val</span> cache_stats : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int * int</span></code></div></div></div></body></html>