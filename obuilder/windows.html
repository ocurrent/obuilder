<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>windows (obuilder.windows)</title><link rel="stylesheet" href="../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> – <a href="index.html">obuilder</a> &#x00BB; windows</nav><header class="odoc-preamble"><h1 id="obuilder's-docker-backend"><a href="#obuilder's-docker-backend" class="anchor"></a>OBuilder's Docker backend</h1><p>&gt; OBuilder takes a build script \(similar to a Dockerfile\) and performs &gt; the steps in it in a sandboxed environment. &gt; &gt; After each step, OBuilder uses the snapshot feature of the &gt; filesystem to store the state of the build. <code>…</code> Repeating a build &gt; will reuse the cached results where possible. &gt; &gt; &gt; BSD tar: <a href="https://ss64.com/nt/tar.html">https://ss64.com/nt/tar.html</a> &gt; Esperanto: <a href="https://github.com/dinosaure/esperanto">https://github.com/dinosaure/esperanto</a> &gt; VSS: <a href="https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service">https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service</a> &gt; WinBtrfs: <a href="https://github.com/maharmstone/btrfs">https://github.com/maharmstone/btrfs</a> &gt; ^1: <a href="maybe">maybe</a> &gt; docker cp: <a href="https://docs.docker.com/engine/reference/commandline/cp/">https://docs.docker.com/engine/reference/commandline/cp/</a> &gt; mounting volumes: <a href="https://docs.docker.com/storage/volumes/">https://docs.docker.com/storage/volumes/</a> &gt; runc: <a href="https://github.com/opencontainers/runc">https://github.com/opencontainers/runc</a> &gt; windowscontainers: <a href="https://learn.microsoft.com/en-us/virtualization/windowscontainers/about/">https://learn.microsoft.com/en-us/virtualization/windowscontainers/about/</a></p></header><nav class="odoc-toc"><ul><li><a href="#motivation">Motivation</a></li><li><a href="#comparing-docker-and-native-backends">Comparing Docker and native backends</a></li><li><a href="#obuilder-operation">OBuilder operation</a></li><li><a href="#copying-files-in-&amp;amp;-out-of-guests">Copying files in &amp;amp; out of guests</a></li><li><a href="#obuilder's-snapshots-and-caches">OBuilder's snapshots and caches</a></li></ul></nav><div class="odoc-content"><h2 id="motivation"><a href="#motivation" class="anchor"></a>Motivation</h2><p>Windows offers <code>native containers</code><code>windowscontainers</code> for sandboxing. Finding a snapshotting filesystem might be more involved, there's <code>Volume Shadow Copy Service (VSS)</code><code>VSS</code> and <code>WinBtrfs</code>. There's however no direct API for these services, they're not stable yet and have few users, and composing them seems a temerary endeavour.</p><p>The choice was made to use Docker as a sandboxing and storage solution for OBuilder. Docker has considerably more users, and hides some of the complexity of interfacing with the operating system.</p><p>Docker being a portable system \(with some caveats\), the OBuilder Docker backend can itself be run in theory over any system Docker supports. Using native components, wherever available, should be preferred. On Windows, Docker can run sunboxed applications using either containerization or virtual machines \(VM\) with Hyper-V. On macOS Docker currently works using virtual machines. The virtualization layer makes it more costly to run code, compared to containerization under Linux. Virtual machines provide more effective isolation and stability under Windows, prompting OBuilder to default to VMs.</p><h2 id="comparing-docker-and-native-backends"><a href="#comparing-docker-and-native-backends" class="anchor"></a>Comparing Docker and native backends</h2><p>The distinction between the sandboxing engine and the storage layer in OBuilder doesn't exactly map to the Docker backend, as both sandbox and store are provided by Docker and can't be swapped out for another implementation. As such, OBuilder will now differentiate between a <em>native</em> sandboxing solution, such as <code>runc</code> under Linux, coupled with a storage engine, and the Docker backend, providing all-in-one sandbox and storage.</p><p>The underlying <code>Store</code> and <code>Sandbox</code> modules can't be as decoupled either with the Docker backend, they need to share more information. This distinction is however useful enough for modularity that it is retained.</p><p>The main difference resides in the fact that with the usual native sandbox and storage solution, OBuilder is totally in charge: it creates its own build identifiers, manages the filesystem, and spawns containers. With the Docker backend however, Docker's the second player of the game. Docker has its own view of the global state, assigns its own identifiers to images and containers. Extra care must be taken to ensure that OBuilder and Docker have a consistent view of objects they're tracking.</p><p>Objects residing in the file system are &quot;namespaced&quot; using OBuilder's state directory; with the Docker backend a small unique identifer for each running OBuilder process is computed based on the instance working directory, and makes up a prefix for all Docker objects managed by this instance. This allows to track objects more easily, and a clean table sweep of any left-overs.</p><p>Another notable difference is that with runc and traditional filesystems, OBuilder can use tools from the host filesystem, for instance to copy or compress files, as well as tools from inside the guest filesystem, chosing or not to run them in the sandbox. With the Docker backend, guest data isn't accessible from the host, thus tools must be present in the guest image, or mounted in volumes in running containers to operate on data in guest images.</p><h2 id="obuilder-operation"><a href="#obuilder-operation" class="anchor"></a>OBuilder operation</h2><p>Using volumes is oftentimes problematic as standard users of the host don't have read/write permissions on them by default, which involves some system administration to set up. It's difficult to retain the settings, and difficult to port, which is why OBuilder's Docker backend tries to refrain from using Docker volumes as much as possible, or only interact with them whilst mounted in containers.</p><h2 id="copying-files-in-&amp;amp;-out-of-guests"><a href="#copying-files-in-&amp;amp;-out-of-guests" class="anchor"></a>Copying files in &amp;amp; out of guests</h2><p>There's two mode of operation for copying files in OBuilder: from the context \(the host filesystem\), or from a previous build stage. As Docker images are not directly writable from the host filesystem, this involves communicating the data to a running container. The data could either be given through a mounted volume, with <code>`docker cp`</code><code>docker
cp</code>, or with a container executing <code>tar</code>. Volumes management is hard, <code>docker cp</code> fails on some files in Windows. For stability, we prefer using a container and tar files \(preserving permissions, file attributes, and allowing easy rewrite of paths\). In some cases, it is necessary to backup the permissions of the destination directory to restore them after the tarball's extraction.</p><p>Creating a tar file in OBuilder involves creating a <em>manifest</em>. It's a tree data structure describing the file hierachy, with node types \(file, directory, symlink\), names, and checksum for file content. The manifest is generated in a fully-reproducible way, so that its checksum can uniquely identify the data being copyied, in order to cache the copy step.</p><p>Copying files from a previous build step is a bit more involved, as once again the host doesn't have direct read access to the content of Docker images. A solution could have been to run the manifest creation code of OBuilder itself in a container, by mounting a volume containing an simple OCaml executable with this code. It would sadly be difficult to accomplish<code>^1</code> in the general case, as the OCaml executable would need to correspond to the Docker image \(arch, glibc\). The choice was made instead of porting the manifest creation code, originally in OCaml, to bash. It produces the same output and errors. It is assumed that Linux distributions ship a bash interpretor, and tar. For Windows, OBuilder starts by creating a volume, nicknamed <em>obuilder-libexec</em>, in which it copies the shell script, and necessary tools from Cygwin to execute it \(the shell executable, some coreutils, tar\). OBuilder can then run a container based on the source image, with the <em>libexec</em> volume mounted read-only, to create and output the manifest. After the manifest is created, OBuilder calls <code>tar</code> in the same fashion to extract data from the previous image, rewrites the tar headers with the correct destination on-the-fly, and pipes the result to the destination container, running tar in extraction mode, reading from stdin.</p><p>Windows 10 ships <code>BSD tar</code>, but it doesn't understand symlinks.</p><p>not so much with <code>Esperanto</code>?</p><h2 id="obuilder's-snapshots-and-caches"><a href="#obuilder's-snapshots-and-caches" class="anchor"></a>OBuilder's snapshots and caches</h2><p>When OBuilder executes a build step <em>B</em> for the first time with a snapshotting filesystem, it'll first look up or fetch the base image <em>A</em> of <em>B</em>. OBuilder then creates a snapshot <em>B'</em> of <em>A</em>, and execute the build using <em>B'</em>. If the build step succeeds, <em>B'</em> is promoted as <em>B</em>; if not, <em>B'</em> is discarded.</p><p>Using the Docker backend, this resolves to checking whether a Docker image <em>B</em> associated with an OBuilder build exists. If not, tag <em>A</em> as <em>tmp-B</em>, and run the build <em>B</em> in a Docker container with the tag <em>tmp-B</em>. If it succeeds, <em>tmp-B</em> can be commited as the Docker image <em>B</em>, then <em>tmp-B</em> is condemned to <em>damnatio memoriae</em>. Special care must be taken as committing the container replaces the <em>entrypoint</em> and <em>cmd</em> fields of the Docker image by the commands given to run the container. This is usually not intended, so these fields are retrieved and restored from the base image.</p><p>Below is a sample build script and OBuilder logs, run on Windows.</p><pre class="language-ocaml"><code>((from mcr.microsoft.com/windows/servercore:ltsc2022) ; A
 (run (shell &quot;echo hello &gt; world&quot;)) ; B
 (run (shell &quot;type world&quot;))) ; C</code></pre><pre class="language-ocaml"><code>$ obuilder build -f simple.spec --store=docker:./var --docker-cpus=8 --docker-memory=4g -v .</code></pre><pre class="language-ocaml"><code>obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;container&quot; &quot;ls&quot; &quot;--all&quot; &quot;--filter&quot; &quot;name=^obuilder-3b98949&quot; &quot;-q&quot;
obuilder.exe: [INFO] Removing left-over Docker images
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;images&quot; &quot;--format={{ .Repository }}&quot; &quot;obuilder-3b98949-image-tmp-*&quot;
obuilder.exe: [INFO] Removing left-over Docker volumes
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;volume&quot; &quot;ls&quot; &quot;--quiet&quot; &quot;--filter&quot; &quot;name=^obuilder-3b98949-cache-tmp-&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;volume&quot; &quot;inspect&quot; &quot;--&quot; &quot;obuilder-3b98949-libexec&quot;
(from mcr.microsoft.com/windows/servercore:ltsc2022)
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--&quot; &quot;obuilder-3b98949-image-bc3bc8408e84c12c2b5f24aa91b444894b55e26069b66e8034890634b08aef1d&quot;
Error: No such image: obuilder-3b98949-image-bc3bc8408e84c12c2b5f24aa91b444894b55e26069b66e8034890634b08aef1d
obuilder.exe: [INFO] Base image not present; importing &quot;mcr.microsoft.com/windows/servercore:ltsc2022&quot;…
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;pull&quot; &quot;mcr.microsoft.com/windows/servercore:ltsc2022&quot;
ltsc2022: Pulling from windows/servercore
Digest: sha256:3949614905ddf2c4451b18894563c36f0c0aa93ab0e17ea6f8ca3791313e4e4f
Status: Image is up to date for mcr.microsoft.com/windows/servercore:ltsc2022
mcr.microsoft.com/windows/servercore:ltsc2022
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;tag&quot; &quot;mcr.microsoft.com/windows/servercore:ltsc2022&quot; &quot;obuilder-3b98949-image-bc3bc8408e84c12c2b5f24aa91b444894b55e26069b66e8034890634b08aef1d&quot;
---&gt; saved as &quot;bc3bc8408e84c12c2b5f24aa91b444894b55e26069b66e8034890634b08aef1d&quot;
C:/: (run (shell &quot;echo hello &gt; world&quot;))
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--&quot; &quot;obuilder-3b98949-image-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
Error: No such image: obuilder-3b98949-image-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;tag&quot; &quot;obuilder-3b98949-image-bc3bc8408e84c12c2b5f24aa91b444894b55e26069b66e8034890634b08aef1d&quot; &quot;obuilder-3b98949-image-tmp-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=container&quot; &quot;--&quot; &quot;obuilder-3b98949-container-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
Error: No such container: obuilder-3b98949-container-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;run&quot; &quot;-i&quot; &quot;--name&quot; &quot;obuilder-3b98949-container-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot; &quot;--cpus&quot; &quot;8.000000&quot; &quot;--isolation&quot; &quot;hyperv&quot; &quot;--hostname&quot; &quot;builder&quot; &quot;--workdir&quot; &quot;C:/&quot; &quot;--entrypoint&quot; &quot;cmd&quot; &quot;--memory&quot; &quot;4g&quot; &quot;--user&quot; &quot;ContainerAdministrator&quot; &quot;obuilder-3b98949-image-tmp-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot; &quot;/S&quot; &quot;/C&quot; &quot;echo hello &gt; world&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--format={{json .Config.Entrypoint }}&quot; &quot;--&quot; &quot;obuilder-3b98949-image-tmp-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--format={{json .Config.Cmd }}&quot; &quot;--&quot; &quot;obuilder-3b98949-image-tmp-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;commit&quot; &quot;--change=CMD [&quot;c:\\windows\\system32\\cmd.exe&quot;]&quot; &quot;--&quot; &quot;obuilder-3b98949-container-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot; &quot;obuilder-3b98949-image-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;rm&quot; &quot;--force&quot; &quot;--&quot; &quot;obuilder-3b98949-container-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
sha256:31d1fcc968e21a34fca97a73b56500b0e0208df9c8be60f5eed8369f107878ab
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;image&quot; &quot;rm&quot; &quot;obuilder-3b98949-image-tmp-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
obuilder-3b98949-container-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd
Untagged: obuilder-3b98949-image-tmp-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd:latest
---&gt; saved as &quot;ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot;
C:/: (run (shell &quot;type world&quot;))
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--&quot; &quot;obuilder-3b98949-image-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
Error: No such image: obuilder-3b98949-image-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;tag&quot; &quot;obuilder-3b98949-image-ac4488b2ca69de829c9a8bbcd9efa2ddff493a3b5888a53ec20a1343ea34b2bd&quot; &quot;obuilder-3b98949-image-tmp-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=container&quot; &quot;--&quot; &quot;obuilder-3b98949-container-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
Error: No such container: obuilder-3b98949-container-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;run&quot; &quot;-i&quot; &quot;--name&quot; &quot;obuilder-3b98949-container-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot; &quot;--cpus&quot; &quot;8.000000&quot; &quot;--isolation&quot; &quot;hyperv&quot; &quot;--hostname&quot; &quot;builder&quot; &quot;--workdir&quot; &quot;C:/&quot; &quot;--entrypoint&quot; &quot;cmd&quot; &quot;--memory&quot; &quot;4g&quot; &quot;--user&quot; &quot;ContainerAdministrator&quot; &quot;obuilder-3b98949-image-tmp-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot; &quot;/S&quot; &quot;/C&quot; &quot;type world&quot;
hello
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--format={{json .Config.Entrypoint }}&quot; &quot;--&quot; &quot;obuilder-3b98949-image-tmp-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;inspect&quot; &quot;--type=image&quot; &quot;--format={{json .Config.Cmd }}&quot; &quot;--&quot; &quot;obuilder-3b98949-image-tmp-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;commit&quot; &quot;--change=CMD [&quot;c:\\windows\\system32\\cmd.exe&quot;]&quot; &quot;--change=ENTRYPOINT [&quot;cmd&quot;]&quot; &quot;--&quot; &quot;obuilder-3b98949-container-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot; &quot;obuilder-3b98949-image-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;rm&quot; &quot;--force&quot; &quot;--&quot; &quot;obuilder-3b98949-container-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
sha256:fa67558f979026a08c63c56215253bec59da6d7dff67bf083fb580f96fe1a820
obuilder-3b98949-container-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153
obuilder.exe: [INFO] Exec &quot;docker&quot; &quot;image&quot; &quot;rm&quot; &quot;obuilder-3b98949-image-tmp-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
Untagged: obuilder-3b98949-image-tmp-7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153:latest
---&gt; saved as &quot;7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;
Got: &quot;7332a0565a4047bdd2c0b778bf3a9175518218879547eb8ddde6832d57861153&quot;</code></pre><p>There's also the shared build cache which can be used to mount one or more persistent caches for the command. It is also usually implemented with the snapshotting filesystem. With Docker, this feature is implemented by <code>mounting volumes</code> in Docker containers. They have the major disadvantage that there's no copy-on-write or snapshotting available for volumes. They first have to be copied, and testing has proved that copying on the host is unreliable because of permissions, so the source volume is tar'ed in a container, and the tar is streamed into a second container extracting it to the destination volume.</p><p>A piece of advice: if you try to implement any feature with Docker on Windows, make sure it works first in a shell script, if possible.</p><p><em>Mettez Docker à l'ouvrage!</em></p><p>BSD tar: <a href="https://ss64.com/nt/tar.html">https://ss64.com/nt/tar.html</a> Esperanto: <a href="https://github.com/dinosaure/esperanto">https://github.com/dinosaure/esperanto</a> VSS: <a href="https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service">https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service</a> WinBtrfs: <a href="https://github.com/maharmstone/btrfs">https://github.com/maharmstone/btrfs</a> ^1: <a href="maybe">maybe</a> docker cp: <a href="https://docs.docker.com/engine/reference/commandline/cp/">https://docs.docker.com/engine/reference/commandline/cp/</a> mounting volumes: <a href="https://docs.docker.com/storage/volumes/">https://docs.docker.com/storage/volumes/</a> runc: <a href="https://github.com/opencontainers/runc">https://github.com/opencontainers/runc</a> windowscontainers: <a href="https://learn.microsoft.com/en-us/virtualization/windowscontainers/about/">https://learn.microsoft.com/en-us/virtualization/windowscontainers/about/</a></p></div></body></html>